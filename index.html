<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test di Vendita TRONY</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4A90E2; /* Blu pi√π professionale */
            --secondary-color: #6C757D; /* Grigio soft */
            --accent-color: #28A745; /* Verde per successi */
            --warning-color: #FFC107; /* Giallo per attenzione */
            --danger-color: #DC3545; /* Rosso per problemi */
            --background-light: #F8F9FA; /* Sfondo chiaro */
            --background-dark: #E9ECEF; /* Sfondo scuro per elementi readonly */
            --text-color: #343A40; /* Testo scuro */
            --border-color: #CED4DA; /* Bordo input */
            --shadow-light: rgba(0, 0, 0, 0.08);
            --shadow-medium: rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: 'Inter', sans-serif;
            max-width: 900px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: var(--background-light);
            color: var(--text-color);
            line-height: 1.6;
        }
        .form-container {
            background: white;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 20px var(--shadow-light);
            border: 1px solid #e0e0e0;
        }
        .header {
            text-align: center;
            background: linear-gradient(135deg, #4A90E2 0%, #0E6CBA 100%); /* Gradiente blu pi√π profondo */
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .header h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 700;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.6rem;
            color: var(--text-color);
            font-size: 0.95rem;
        }
        input[type="text"], input[type="date"], select, textarea {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: white;
            -webkit-appearance: none; /* Rimuove lo stile predefinito per select */
            -moz-appearance: none;
            appearance: none;
        }
        input[type="text"]:focus, input[type="date"]:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2); /* Ombra focus */
            outline: none;
        }
        select {
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23343A40" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.8rem center;
            background-size: 1.2em;
        }
        input[type="text"][readonly], input[type="date"][readonly], textarea[readonly] {
            background-color: var(--background-dark);
            cursor: not-allowed;
            border-color: #DDE2E7;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        .evaluation-section {
            background: var(--background-light);
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            border-left: 5px solid var(--primary-color); /* Bordo pi√π spesso e colorato */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .evaluation-title {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }
        .rating-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 0.8rem;
            border-top: 1px dashed #e0e0e0; /* Linea separatrice */
        }
        .rating-container label {
            margin: 0;
            font-weight: 600;
            white-space: nowrap;
        }
        .buttons-container {
            display: flex;
            gap: 1.2rem;
            justify-content: center;
            margin-top: 3rem;
            flex-wrap: wrap;
        }
        .btn {
            padding: 0.9rem 1.8rem;
            border: none;
            border-radius: 8px;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s ease-in-out;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            text-decoration: none; /* Rimuove sottolineatura dai link button */
        }
        .btn-telegram {
            background: linear-gradient(135deg, #0088cc 0%, #007AB8 100%); /* Blu Telegram */
            color: white;
        }
        .btn-telegram:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,136,204,0.3);
        }
        .btn-word {
            background: linear-gradient(135deg, #2B579A 0%, #1F457A 100%); /* Blu scuro Word */
            color: white;
        }
        .btn-word:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(43,87,154,0.3);
        }
        .btn-email {
            background: linear-gradient(135deg, #DC3545 0%, #C42D3C 100%); /* Rosso Email */
            color: white;
        }
        .btn-email:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(220,53,69,0.3);
        }
        .two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        .three-columns {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        @media (max-width: 768px) {
            body {
                padding: 1rem;
                margin: 1rem auto;
            }
            .form-container {
                padding: 1.5rem;
            }
            .header h1 {
                font-size: 1.75rem;
            }
            .two-columns, .three-columns {
                grid-template-columns: 1fr;
            }
            .buttons-container {
                flex-direction: column;
                gap: 1rem;
            }
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="form-container">
        <div class="header">
            <h1>üìä TEST DI VENDITA TRONY</h1>
        </div>

        <form id="testVenditaForm">
            <div class="two-columns">
                <div class="form-group">
                    <label for="pdv">PUNTO VENDITA:</label>
                    <select id="pdv" name="pdv" required>
                        <option value="">Seleziona punto vendita...</option>
                        <option value="FANO">FANO</option>
                        <option value="MONSANO">MONSANO</option>
                        <option value="OSIMO">OSIMO</option>
                        <option value="MACERATA">MACERATA</option>
                        <option value="CIVITANOVA">CIVITANOVA</option>
                        <option value="PESARO">PESARO</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="data">DATA:</label>
                    <input type="text" id="data" name="data" readonly placeholder="Data attuale verr√† inserita qui">
                </div>
            </div>

            <div class="form-group">
                <label for="addetto">ADDETTO:</label>
                <input type="text" id="addetto" name="addetto" required>
            </div>

            <div class="form-group">
                <label for="reparto">REPARTO:</label>
                <select id="reparto" name="reparto" required>
                    <option value="">Seleziona reparto...</option>
                    <option value="GED">GED</option>
                    <option value="PED">PED</option>
                    <option value="ISOLA">ISOLA</option>
                    <option value="INFO">INFO</option>
                    <option value="TV">TV</option>
                </select>
            </div>

            <div class="evaluation-section">
                <div class="evaluation-title">ü§ù ACCOGLIENZA</div>
                <div class="three-columns">
                    <div class="form-group">
                        <label for="saluto">SALUTO:</label>
                        <select id="saluto" name="saluto" required onchange="generateSummaryJudgment()">
                            <option value="">Seleziona...</option>
                            <option value="OK">OK</option>
                            <option value="MIGLIORABILE">MIGLIORABILE</option>
                            <option value="MALE">MALE</option>
                            <option value="NULLA">NULLA</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="approccio">APPROCCIO:</label>
                        <select id="approccio" name="approccio" required onchange="generateSummaryJudgment()">
                            <option value="">Seleziona...</option>
                            <option value="OK">OK</option>
                            <option value="MIGLIORABILE">MIGLIORABILE</option>
                            <option value="MALE">MALE</option>
                            <option value="NULLA">NULLA</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="empatia">EMPATIA:</label>
                        <select id="empatia" name="empatia" required onchange="generateSummaryJudgment()">
                            <option value="">Seleziona...</option>
                            <option value="OK">OK</option>
                            <option value="MIGLIORABILE">MIGLIORABILE</option>
                            <option value="MALE">MALE</option>
                            <option value="NULLA">NULLA</option>
                        </select>
                    </div>
                </div>
                <div class="rating-container">
                    <label for="val_saluto">Valutazione:</label>
                    <select id="val_saluto" name="val_saluto" required onchange="calculateOverallRating(); generateSummaryJudgment();">
                        <option value="">Seleziona...</option>
                        <option value="4">4 - GRAVEMENTE INSUFFICIENTE</option>
                        <option value="5">5 - INSUFFICIENTE</option>
                        <option value="6">6 - SUFFICIENTE</option>
                        <option value="7">7 - BUONO</option>
                        <option value="8">8 - DISTINTO</option>
                        <option value="9">9 - OTTIMO</option>
                    </select>
                </div>
            </div>

            <div class="evaluation-section">
                <div class="evaluation-title">üíº GESTIONE VENDITA</div>
                <div class="three-columns">
                    <div class="form-group">
                        <label for="trattativa">TRATTATIVA:</label>
                        <select id="trattativa" name="trattativa" required onchange="generateSummaryJudgment()">
                            <option value="">Seleziona...</option>
                            <option value="OK">OK</option>
                            <option value="MIGLIORABILE">MIGLIORABILE</option>
                            <option value="MALE">MALE</option>
                            <option value="NULLA">NULLA</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="upselling">UP SELLING:</label>
                        <select id="upselling" name="upselling" required onchange="generateSummaryJudgment()">
                            <option value="">Seleziona...</option>
                            <option value="OK">OK</option>
                            <option value="MIGLIORABILE">MIGLIORABILE</option>
                            <option value="MALE">MALE</option>
                            <option value="NULLA">NULLA</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="conoscenze">CONOSCENZE:</label>
                        <select id="conoscenze" name="conoscenze" required onchange="generateSummaryJudgment()">
                            <option value="">Seleziona...</option>
                            <option value="OK">OK</option>
                            <option value="MIGLIORABILE">MIGLIORABILE</option>
                            <option value="MALE">MALE</option>
                            <option value="NULLA">NULLA</option>
                        </select>
                    </div>
                </div>
                <div class="rating-container">
                    <label for="val_trattativa">Valutazione:</label>
                    <select id="val_trattativa" name="val_trattativa" required onchange="calculateOverallRating(); generateSummaryJudgment();">
                        <option value="">Seleziona...</option>
                        <option value="4">4 - GRAVEMENTE INSUFFICIENTE</option>
                        <option value="5">5 - INSUFFICIENTE</option>
                        <option value="6">6 - SUFFICIENTE</option>
                        <option value="7">7 - BUONO</option>
                        <option value="8">8 - DISTINTO</option>
                        <option value="9">9 - OTTIMO</option>
                    </select>
                </div>
            </div>

            <div class="evaluation-section">
                <div class="evaluation-title">üîÑ GESTIONE KPI</div>
                <div class="three-columns">
                    <div class="form-group">
                        <label for="crossselling">CROSS SELLING:</label>
                        <select id="crossselling" name="crossselling" required onchange="generateSummaryJudgment()">
                            <option value="">Seleziona...</option>
                            <option value="OK">OK</option>
                            <option value="MIGLIORABILE">MIGLIORABILE</option>
                            <option value="MALE">MALE</option>
                            <option value="NULLA">NULLA</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gestore">GESTORE:</label>
                        <select id="gestore" name="gestore" required onchange="generateSummaryJudgment()">
                            <option value="">Seleziona...</option>
                            <option value="OK">OK</option>
                            <option value="MIGLIORABILE">MIGLIORABILE</option>
                            <option value="MALE">MALE</option>
                            <option value="NULLA">NULLA</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="estensioni">ESTENSIONI:</label>
                        <select id="estensioni" name="estensioni" required onchange="generateSummaryJudgment()">
                            <option value="">Seleziona...</option>
                            <option value="OK">OK</option>
                            <option value="MIGLIORABILE">MIGLIORABILE</option>
                            <option value="MALE">MALE</option>
                            <option value="NULLA">NULLA</option>
                        </select>
                    </div>
                </div>
                <div class="rating-container">
                    <label for="val_cross">Valutazione:</label>
                    <select id="val_cross" name="val_cross" required onchange="calculateOverallRating(); generateSummaryJudgment();">
                        <option value="">Seleziona...</option>
                        <option value="4">4 - GRAVEMENTE INSUFFICIENTE</option>
                        <option value="5">5 - INSUFFICIENTE</option>
                        <option value="6">6 - SUFFICIENTE</option>
                        <option value="7">7 - BUONO</option>
                        <option value="8">8 - DISTINTO</option>
                        <option value="9">9 - OTTIMO</option>
                    </select>
                </div>
            </div>

            <div class="evaluation-section">
                <div class="evaluation-title">üéØ USO ARMI</div>
                <div class="three-columns">
                    <div class="form-group">
                        <label for="promo">PROMO IN CORSO:</label>
                        <select id="promo" name="promo" required onchange="generateSummaryJudgment()">
                            <option value="">Seleziona...</option>
                            <option value="OK">OK</option>
                            <option value="MIGLIORABILE">MIGLIORABILE</option>
                            <option value="MALE">MALE</option>
                            <option value="NULLA">NULLA</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="indicazioni">INDICAZIONI:</label>
                        <select id="indicazioni" name="indicazioni" required onchange="generateSummaryJudgment()">
                            <option value="">Seleziona...</option>
                            <option value="OK">OK</option>
                            <option value="MIGLIORABILE">MIGLIORABILE</option>
                            <option value="MALE">MALE</option>
                            <option value="NULLA">NULLA</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dilazioni">DILAZIONI:</label>
                        <select id="dilazioni" name="dilazioni" required onchange="generateSummaryJudgment()">
                            <option value="">Seleziona...</option>
                            <option value="OK">OK</option>
                            <option value="MIGLIORABILE">MIGLIORABILE</option>
                            <option value="MALE">MALE</option>
                            <option value="NULLA">NULLA</option>
                        </select>
                    </div>
                </div>
                <div class="rating-container">
                    <label for="val_promo">Valutazione:</label>
                    <select id="val_promo" name="val_promo" required onchange="calculateOverallRating(); generateSummaryJudgment();">
                        <option value="">Seleziona...</option>
                        <option value="4">4 - GRAVEMENTE INSUFFICIENTE</option>
                        <option value="5">5 - INSUFFICIENTE</option>
                        <option value="6">6 - SUFFICIENTE</option>
                        <option value="7">7 - BUONO</option>
                        <option value="8">8 - DISTINTO</option>
                        <option value="9">9 - OTTIMO</option>
                    </select>
                </div>
            </div>

            <div class="evaluation-section">
                <div class="evaluation-title">üí≥ CONCLUSIONE VENDITA</div>
                <div class="three-columns">
                    <div class="form-group">
                        <label for="cartafan">CARTA FAN:</label>
                        <select id="cartafan" name="cartafan" required onchange="generateSummaryJudgment()">
                            <option value="">Seleziona...</option>
                            <option value="OK">OK</option>
                            <option value="MIGLIORABILE">MIGLIORABILE</option>
                            <option value="MALE">MALE</option>
                            <option value="NULLA">NULLA</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="myfansafe">MYFANSAFE:</label>
                        <select id="myfansafe" name="myfansafe" required onchange="generateSummaryJudgment()">
                            <option value="">Seleziona...</option>
                            <option value="OK">OK</option>
                            <option value="MIGLIORABILE">MIGLIORABILE</option>
                            <option value="MALE">MALE</option>
                            <option value="NULLA">NULLA</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="protocollo">PROTOCOLLO:</label>
                        <select id="protocollo" name="protocollo" required onchange="generateSummaryJudgment()">
                            <option value="">Seleziona...</option>
                            <option value="OK">OK</option>
                            <option value="MIGLIORABILE">MIGLIORABILE</option>
                            <option value="MALE">MALE</option>
                            <option value="NULLA">NULLA</option>
                        </select>
                    </div>
                </div>
                <div class="rating-container">
                    <label for="val_carta">Valutazione:</label>
                    <select id="val_carta" name="val_carta" required onchange="calculateOverallRating(); generateSummaryJudgment();">
                        <option value="">Seleziona...</option>
                        <option value="4">4 - GRAVEMENTE INSUFFICIENTE</option>
                        <option value="5">5 - INSUFFICIENTE</option>
                        <option value="6">6 - SUFFICIENTE</option>
                        <option value="7">7 - BUONO</option>
                        <option value="8">8 - DISTINTO</option>
                        <option value="9">9 - OTTIMO</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="considerazioni">CONSIDERAZIONI:</label>
                <textarea id="considerazioni" name="considerazioni" placeholder="Es: LA RAGAZZA DEVE ESSERE PRIMA..NE HA LA POSSIBILITA'"></textarea>
            </div>

            <div class="form-group">
                <label for="conclusione">CONCLUSIONE COMPLESSIVA:</label>
                <textarea id="conclusione" name="conclusione" placeholder="Es: ANALISI COSTANTE TENERE SEMPRE IN TIRO"></textarea>
            </div>
            
            <div class="form-group">
                <label for="valutazione_complessiva">Valutazione Complessiva (media delle aree):</label>
                <input type="text" id="valutazione_complessiva" name="valutazione_complessiva" readonly>
            </div>

            <div class="form-group">
                <label for="giudizio_riepilogativo">Giudizio Riepilogativo:</label>
                <textarea id="giudizio_riepilogativo" name="giudizio_riepilogativo" readonly></textarea>
            </div>

            <div class="form-group">
                <label for="redattore">TEST DI VENDITA REDATTO DA:</label>
                <input type="text" id="redattore" name="redattore" required>
            </div>

            <div class="form-group">
                <label for="ruolo">RUOLO:</label>
                <select id="ruolo" name="ruolo" required>
                    <option value="">Seleziona ruolo...</option>
                    <option value="SUPERVISORE">SUPERVISORE</option>
                    <option value="DIRETTORE">DIRETTORE</option>
                    <option value="VICE">VICE</option>
                    <option value="GRATICOLA">GRATICOLA</option>
                </select>
            </div>

            <div class="buttons-container">
                <button type="button" class="btn btn-telegram" onclick="sendToTelegram()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    Invia su Telegram
                </button>
                <button type="button" class="btn btn-word" onclick="exportToWord()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    Esporta in Word
                </button>
                <button type="button" class="btn btn-email" onclick="sendEmail()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                    Invia Email
                </button>
            </div>
        </form>
    </div>

    <script>
        function formatDate(date) {
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            return date.toLocaleDateString('it-IT', options);
        }

        function calculateOverallRating() {
            const valSaluto = parseFloat(document.getElementById('val_saluto').value);
            const valTrattativa = parseFloat(document.getElementById('val_trattativa').value);
            const valCross = parseFloat(document.getElementById('val_cross').value);
            const valPromo = parseFloat(document.getElementById('val_promo').value);
            const valCarta = parseFloat(document.getElementById('val_carta').value);

            let sum = 0;
            let count = 0;

            if (!isNaN(valSaluto)) { sum += valSaluto; count++; }
            if (!isNaN(valTrattativa)) { sum += valTrattativa; count++; }
            if (!isNaN(valCross)) { sum += valCross; count++; }
            if (!isNaN(valPromo)) { sum += valPromo; count++; }
            if (!isNaN(valCarta)) { sum += valCarta; count++; }

            if (count > 0) {
                const average = sum / count;
                document.getElementById('valutazione_complessiva').value = average.toFixed(1); // Arrotonda a un decimale
            } else {
                document.getElementById('valutazione_complessiva').value = '';
            }
        }

        function generateSummaryJudgment() {
            const overallRating = parseFloat(document.getElementById('valutazione_complessiva').value);
            let judgment = '';
            let isAnyRatingSelected = false;

            // Check if at least one numerical rating is selected
            const numericalRatings = ['val_saluto', 'val_trattativa', 'val_cross', 'val_promo', 'val_carta'];
            for (const id of numericalRatings) {
                if (document.getElementById(id).value !== '') {
                    isAnyRatingSelected = true;
                    break;
                }
            }

            if (!isAnyRatingSelected || isNaN(overallRating)) {
                document.getElementById('giudizio_riepilogativo').value = 'Seleziona le valutazioni numeriche e qualitative per generare un giudizio riepilogativo.';
                return;
            }

            // Base judgment on overall numeric rating
            if (overallRating >= 8.5) {
                judgment += 'Eccellente prestazione generale! L\'addetto ha dimostrato piena padronanza delle tecniche di vendita e un\'ottima gestione del cliente. ';
            } else if (overallRating >= 7.0) {
                judgment += 'Buona performance complessiva. Sono state riscontrate solide capacit√† di vendita. ';
            } else if (overallRating >= 6.0) {
                judgment += 'Prestazione sufficiente. Ci sono margini di miglioramento in alcune aree chiave. ';
            } else {
                judgment += 'Prestazione insufficiente. Sono necessarie azioni correttive immediate e un piano di formazione mirato. ';
            }

            let areasToImprove = [];
            let areasWithOk = [];

            // Check qualitative ratings for specific feedback
            const areas = {
                'Accoglienza': ['saluto', 'approccio', 'empatia'],
                'Gestione Vendita': ['trattativa', 'upselling', 'conoscenze'],
                'Gestione KPI': ['crossselling', 'gestore', 'estensioni'],
                'Uso Armi': ['promo', 'indicazioni', 'dilazioni'],
                'Conclusione Vendita': ['cartafan', 'myfansafe', 'protocollo']
            };

            for (const area in areas) {
                let issuesInArea = [];
                let allAreaOk = true;
                areas[area].forEach(item => {
                    const value = document.getElementById(item).value;
                    if (value === 'MALE' || value === 'NULLA') {
                        issuesInArea.push(item.replace(/([A-Z])/g, ' $1').trim().toUpperCase()); // Format "myfansafe" to "MY FAN SAFE"
                        allAreaOk = false;
                    } else if (value === 'MIGLIORABILE') {
                         issuesInArea.push(`${item.replace(/([A-Z])/g, ' $1').trim().toUpperCase()} (da migliorare)`);
                         allAreaOk = false;
                    }
                });
                if (issuesInArea.length > 0) {
                    areasToImprove.push(`${area} (problematiche su: ${issuesInArea.join(', ')})`);
                } else if (allAreaOk && areas[area].every(item => document.getElementById(item).value === 'OK')) {
                    areasWithOk.push(area);
                }
            }

            if (areasToImprove.length > 0) {
                judgment += 'Si raccomanda di focalizzare l\'attenzione sulle seguenti aree: ' + areasToImprove.join('; ') + '. ';
            } 
            
            if (areasWithOk.length > 0) {
                judgment += `In particolare, le aree di ${areasWithOk.join(', ')} sono state gestite in modo ottimo. `;
            }

            document.getElementById('giudizio_riepilogativo').value = judgment.trim();
        }

        function generateReport() {
            const form = document.getElementById('testVenditaForm');
            const formData = new FormData(form);
            
            const pdv = formData.get('pdv');
            const data = document.getElementById('data').value;
            const addetto = formData.get('addetto');
            const reparto = formData.get('reparto');
            const redattore = formData.get('redattore');
            const ruolo = formData.get('ruolo');
            
            // Per includere i valori testuali delle valutazioni (es. "4 - GRAVEMENTE INSUFFICIENTE")
            // Aggiungo il controllo `?.text || ''` per gestire i casi in cui non √® selezionata un'opzione
            const valSalutoText = document.getElementById('val_saluto').options[document.getElementById('val_saluto').selectedIndex]?.text || '';
            const valTrattativaText = document.getElementById('val_trattativa').options[document.getElementById('val_trattativa').selectedIndex]?.text || '';
            const valCrossText = document.getElementById('val_cross').options[document.getElementById('val_cross').selectedIndex]?.text || '';
            const valPromoText = document.getElementById('val_promo').options[document.getElementById('val_promo').selectedIndex]?.text || '';
            const valCartaText = document.getElementById('val_carta').options[document.getElementById('val_carta').selectedIndex]?.text || '';


            const report = `**PDV TRONY : ${pdv.toUpperCase()}        DATA. ${data}**

ADDETTO : ${addetto}

REPARTO / ARGOMENTO : ${reparto.toUpperCase()}

* **ACCOGLIENZA**
    * SALUTO: ${formData.get('saluto') || 'N/D'}
    * APPROCCIO: ${formData.get('approccio') || 'N/D'}
    * EMPATIA: ${formData.get('empatia') || 'N/D'}
    Valutazione: ${valSalutoText}

* **GESTIONE VENDITA**
    * TRATTATIVA: ${formData.get('trattativa') || 'N/D'}
    * UP SELLING: ${formData.get('upselling') || 'N/D'}
    * CONOSCENZE: ${formData.get('conoscenze') || 'N/D'}
    Valutazione : ${valTrattativaText}

* **GESTIONE KPI**
    * CROSS SELLING: ${formData.get('crossselling') || 'N/D'}
    * GESTORE: ${formData.get('gestore') || 'N/D'}
    * ESTENSIONI: ${formData.get('estensioni') || 'N/D'}
    Valutazione : ${valCrossText}

* **USO ARMI**
    * PROMO IN CORSO: ${formData.get('promo') || 'N/D'}
    * INDICAZIONI: ${formData.get('indicazioni') || 'N/D'}
    * DILAZIONI: ${formData.get('dilazioni') || 'N/D'}
    Valutazione : ${valPromoText}

* **CONCLUSIONE VENDITA**
    * CARTA FAN: ${formData.get('cartafan') || 'N/D'}
    * MYFANSAFE: ${formData.get('myfansafe') || 'N/D'}
    * PROTOCOLLO: ${formData.get('protocollo') || 'N/D'}
    Valutazione: ${valCartaText}

* **CONSIDERAZIONI : ${formData.get('considerazioni') || 'N/D'}**

* **CONCLUSIONE COMPLESSIVA : ${formData.get('conclusione') || 'N/D'}**

* **Valutazione Complessiva (media): ${formData.get('valutazione_complessiva') || 'N/D'}**

* **Giudizio Riepilogativo: ${formData.get('giudizio_riepilogativo') || 'N/D'}**

TEST DI VENDITA REDATTO DA: ${redattore.toUpperCase() || 'N/D'}
RUOLO: ${ruolo.toUpperCase() || 'N/D'}`;

            return report;
        }

        function sendToTelegram() {
            const report = generateReport();
            const encodedReport = encodeURIComponent(report);
            const telegramUrl = `https://t.me/share/url?url=&text=${encodedReport}`;
            window.open(telegramUrl, '_blank');
        }

        function sendEmail() {
            const report = generateReport();
            const pdv = document.getElementById('pdv').value;
            const addetto = document.getElementById('addetto').value;
            const data = document.getElementById('data').value;

            const subject = encodeURIComponent(`Test di Vendita TRONY - ${pdv || 'N/D'} - ${addetto || 'N/D'} - ${data || 'N/D'}`);
            const body = encodeURIComponent(report);

            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        function exportToWord() {
            const report = generateReport();
            
            // Creazione del documento Word
            const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head>
                    <meta charset='utf-8'>
                    <title>Test di Vendita TRONY</title>
                    <style>
                        body { font-family: Arial, sans-serif; font-size: 12pt; line-height: 1.5; }
                        .header { font-weight: bold; text-align: center; margin-bottom: 20px; }
                        .section { margin-bottom: 15px; }
                        .bold { font-weight: bold; }
                    </style>
                </head>
                <body>`;
            
            // Sostituisci i tag Markdown con tag HTML per il grassetto e le interruzioni di riga
            const bodyContent = report.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                     .replace(/\n/g, '<br>');
            
            const footer = '</body></html>';
            
            const htmlContent = header + '<div>' + bodyContent + '</div>' + footer;
            
            const blob = new Blob([htmlContent], {
                type: 'application/msword'
            });
            
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Test_Vendita_TRONY_${new Date().toISOString().split('T')[0]}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Imposta la data di oggi come default e la rende non modificabile
        function setCurrentDate() {
            const today = new Date();
            const formattedDate = formatDate(today); // Usa la funzione formatDate
            document.getElementById('data').value = formattedDate;
        }
        
        // Imposta la data quando la pagina si carica
        document.addEventListener('DOMContentLoaded', () => {
            setCurrentDate();
            // Aggiungi un listener anche per assicurarti che la media e il giudizio vengano calcolati all'inizio se ci sono valori predefiniti
            calculateOverallRating();
            generateSummaryJudgment();
        });
    </script>
</body>
</html>
